---
title: "读者写者问题浅析"
date: 2018-10-23T21:07:51+08:00
draft: true
---
### 问题描述
> 有读者和写者两组并发进程，共享一个文件，当两个或以上读进程同
>事访问共享数据时不会产生副作用，但若某个写进程和其他进程(读进
>程或写进程)同时访问共享数据时，则可能导致数据不一致的错误。因
> 此要求
> - 允许多个读者可以同时对文件执行读操作
> - 只允许一个写者往文件中写信息
> - 任一写者在完成写操作之前不允许其他读者或写者操作
> - 写者执行写操作之前，应让已有的读者和写者全部退出 

### 问题分析
- 写者进程是比较霸道的，要求独占资源，和其他写者以及读者均互斥，若是写者占到了资源，那么其他写者和读者就得等着。
- 读者进程稍微弱势一些，因为不对资源做修改，所以可以多个读进程一起去读，但是读的时候，不允许有写者进程进程进来干扰。
- 有上述知道，读者和写者之间对资源存在互斥，写者与写者之间也存在互斥，这是同一种互斥，用一个PV操作即可。
- 一个潜在的问题是，多个读者之间的关系，表面上看似乎读者之间没有互斥，但是实际上，读者占有资源时的P操作应该发生在第一个读者进行抢占到资源的时候，而读者释放资源的V操作应该发生在最后一个读者进程离开资源的时候。


### 场景模拟
假设有一个班级，里面有两批学生，一批是写同学，一批是读同学，假设这个班级的全部生活就是往内板写公式和读公式。首先，写同学每次只能一个人去写，每个写同学都有一把特制的锁，只有自己能打开，假设写A同学占到了教室的资源，它就用一把自己特制的锁把教室反锁起来，除非自己开锁出去，否则其他人进不来。其他人包括其他的写同学和读同学。而所有的读同学共享一把相同的锁，这把锁所有的写同学打不开。当第一个读同学进来的时候，先看一看教室有没有其他的读同学，如果没有，说明自己是第一个进来的，负责给教室上锁以免写同学进来。而第二个第三个读同学则尝试用自己的钥匙去开锁，能开则进去读公式，开不了说明是写同学在写公式，需要在外面候着。写同学同理。

- 场景A: 写同学甲来到教室，发现空无一人(未上锁)，于是锁上教室，开始在黑板写公式。此时，无论是写同学乙还是读同学丙都没有机会进入教室，只能在外面候着。

- 场景B: 写同学甲写完出来，并拿掉了自己的锁。这时候读同学丙抢先一步进入教室，发现教室空无一人，于是给教室上锁，这时候写同学乙依然进不去教室，在外面候着。

- 场景C: 接着场景B，读同学丁来到了教室，发现自己能打开锁，说明里面有读者，进去。

- 场景D: 接着场景A，写同学甲刚刚出来，读同学丙和丁几乎同时进入了教室，然后两个人都认为自己不是第一个进来的，于是两个人就都没有去加锁，最后写同学乙闯了进来，GG！

- 场景E: 接着场景D，教室里的读同学纷纷离开，丙和丁是最后两个，但是两个人都认为对方是最后一个走的，于是谁都没有把锁拿走。最后教室空无一人，然而写进程却再也进不来了。GG！

由场景D和E的问题可以得出，读者锁应该在第一个读进程进来时加上，最后一个读进程离开时释放。而且为了保证每个读进程在进来的时候不被干扰地检测加锁情况，进来的时候读者进程之间应该互斥，离开时同理。读者写者的坑应该就在此处了！